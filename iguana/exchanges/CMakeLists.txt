include_directories(${CMAKE_CURRENT_SOURCE_DIR})
set(MM_SOURCES mm.c ../mini-gmp.c ../groestl.c ../segwit_addr.c ../keccak.c LP_etomic.c)
set(MM_LIBS
        curl
        pthread
        libcrypto777
        libjpeg
        libsecp256k1
        /usr/local/opt/openssl/lib/libcrypto.a
        /usr/local/opt/openssl/lib/libssl.a
        dl
        ${CMAKE_SOURCE_DIR}/target/debug/libmm2.a
    )

find_library(OPEN_SSL ssl)
message(STATUS "OPEN SSL PATH: ${OPEN_SSL}")

add_custom_target(mm2rs cargo build WORKING_DIRECTORY ${CMAKE_SOURCE_DIR})

if(WIN32)
link_directories(${CMAKE_SOURCE_DIR}/marketmaker_depends/curl/build_msvc_2015_win64/lib/Release ${CMAKE_SOURCE_DIR}/marketmaker_depends/pthread-win32/bin/x64_MSVC2015.Release ${CMAKE_SOURCE_DIR}/marketmaker_depends/nanomsg/build_msvc_2015_win64/Release)
set(MM_LIBS ${MM_LIBS} nanomsg)
endif()
add_library(marketmaker-testnet-lib ${MM_SOURCES})
add_library(marketmaker-mainnet-lib ${MM_SOURCES})
add_executable(marketmaker-testnet ${MM_SOURCES})
add_executable(marketmaker-mainnet ${MM_SOURCES})
include_directories(../../crypto777)
if(WIN32)
target_compile_definitions(marketmaker-mainnet PRIVATE)
target_compile_definitions(marketmaker-testnet PRIVATE ETOMIC_TESTNET)
target_compile_definitions(marketmaker-mainnet-lib PRIVATE)
target_compile_definitions(marketmaker-testnet-lib PRIVATE ETOMIC_TESTNET)
else()
target_compile_definitions(marketmaker-testnet PRIVATE ETOMIC_TESTNET USE_STATIC_NANOMSG)
target_compile_definitions(marketmaker-mainnet PRIVATE USE_STATIC_NANOMSG)
target_compile_definitions(marketmaker-testnet-lib PRIVATE ETOMIC_TESTNET USE_STATIC_NANOMSG)
target_compile_definitions(marketmaker-mainnet-lib PRIVATE USE_STATIC_NANOMSG)
endif()
if(UNIX)
    target_link_libraries(marketmaker-testnet m)
    target_link_libraries(marketmaker-mainnet m)
    target_link_libraries(marketmaker-testnet-lib m)
    target_link_libraries(marketmaker-mainnet-lib m)
endif()
if(WIN32)
add_definitions(-DNATIVE_WINDOWS)
add_definitions(-DIGUANA_LOG2PACKETSIZE=20)
add_definitions(-DIGUANA_MAXPACKETSIZE=1572864)
add_definitions(-D_CRT_SECURE_NO_WARNINGS)
include_directories("${CMAKE_SOURCE_DIR}/includes")
endif()
target_link_libraries(marketmaker-testnet ${MM_LIBS} etomiclib-testnet)
target_link_libraries(marketmaker-mainnet ${MM_LIBS} etomiclib-mainnet)
target_link_libraries(marketmaker-testnet-lib ${MM_LIBS} etomiclib-testnet)
target_link_libraries(marketmaker-mainnet-lib ${MM_LIBS} etomiclib-mainnet)
if(${CMAKE_SYSTEM_NAME} STREQUAL "Linux")
target_link_libraries(marketmaker-mainnet -static-libgcc -static-libstdc++)
target_link_libraries(marketmaker-testnet -static-libgcc -static-libstdc++)
target_link_libraries(marketmaker-mainnet-lib -static-libgcc -static-libstdc++)
target_link_libraries(marketmaker-testnet-lib -static-libgcc -static-libstdc++)
endif()
add_dependencies(marketmaker-testnet mm2rs)
add_dependencies(marketmaker-mainnet mm2rs)
add_dependencies(marketmaker-testnet-lib mm2rs)
add_dependencies(marketmaker-mainnet-lib mm2rs)
# Link with apple OS libraries
if (APPLE)
    find_library(CoreFoundation CoreFoundation)
    find_library(Security Security)
    message(STATUS "Security PATH: ${Security}")
    target_link_libraries(marketmaker-mainnet ${CoreFoundation} ${Security})
    target_link_libraries(marketmaker-testnet ${CoreFoundation} ${Security})
    target_link_libraries(marketmaker-mainnet-lib ${CoreFoundation} ${Security})
    target_link_libraries(marketmaker-testnet-lib ${CoreFoundation} ${Security})
endif()

if(NOT DEFINED MM_VERSION)
    SET(MM_VERSION UNKNOWN)
endif()
target_compile_definitions(marketmaker-mainnet PRIVATE -DMM_VERSION="${MM_VERSION}")
target_compile_definitions(marketmaker-testnet PRIVATE -DMM_VERSION="${MM_VERSION}")
target_compile_definitions(marketmaker-mainnet-lib PRIVATE -DMM_VERSION="${MM_VERSION}")
target_compile_definitions(marketmaker-testnet-lib PRIVATE -DMM_VERSION="${MM_VERSION}")